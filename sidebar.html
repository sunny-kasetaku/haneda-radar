<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 10px; background: #121212; color: #e0e0e0; font-size: 14px; }
      .area-box { background: #252525; padding: 10px; border-radius: 6px; border: 1px solid #333; margin-bottom: 8px; }
      .label-sm { font-size: 11px; color: #aaa; display: block; margin-bottom: 3px; }
      .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 5px; }
      iframe { width: 100%; height: 260px; border: none; background: white; border-radius: 4px; }
      .editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .full { grid-column: span 2; }
      select, input, textarea { background: #333; color: #fff; border: 1px solid #555; padding: 10px; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 14px; }
      select:focus, input:focus { border-color: #007bff; outline: none; }
      textarea { resize: vertical; } 
      .global-info { background: #1a2236; border: 1px solid #3b5998; padding: 12px; margin-top: 15px; border-radius: 8px; }
      .link-btn-group { display: flex; gap: 5px; margin-bottom: 8px; }
      .link-btn { background: #3b5998; color: white; font-size: 10px; padding: 4px 8px; text-decoration: none; border-radius: 3px; flex: 1; text-align: center; }
      button { padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
      .btn-add { background: #28a745; color: white; }
      .btn-next { background: #007bff; color: white; }
      .btn-global { background: #ffc107; color: #000; width: 100%; font-size: 12px; margin-top:5px; }
      .btn-sub { background: #444; color: white; padding: 8px 12px; }
      .btn-undo { float: right; font-size: 11px; background: #ffc107; color: #000; padding: 4px 8px; border-radius: 3px; }
      .btn-lock { background: #333; color: #888; border: 1px solid #555; font-size: 11px; padding: 5px; width: 80px; }
      .locked { background: #b30000 !important; color: white !important; }
      .history { margin-top: 10px; font-size: 13px; color: #bbb; background: #000; padding: 10px; border-radius: 6px; border: 1px solid #333; }
      .flash { animation: flashAnim 0.8s; }
      @keyframes flashAnim { 0% { background-color: #856404; } 100% { background-color: #333; } }
      #subVenueArea { display: none; margin-top: 5px; background: #333; padding: 5px; border-radius: 4px; border-left: 3px solid #f0ad4e; }
    </style>
  </head>
  <body>
    <div class="area-box" style="background:#2c2c2c;">
      <span class="label-sm">ğŸ“… å…¥åŠ›èµ·ç‚¹æ—¥</span>
      <input type="date" id="baseDate" value="<?= initialDate ?>" onchange="refreshDateLists()">
      <div id="goalDisplay" style="color:#4db8ff; font-weight:bold; margin-top:5px; font-size:13px;">ğŸ¯ ä»Šé€±ã®ç›®å®‰: - ã¾ã§</div>
    </div>

    <div class="nav-bar">
      <div style="display:flex; gap:3px;">
        <button class="btn-sub" onclick="refreshIframe()" title="ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã™">ğŸ  Top</button>
      </div>
      <div style="display:flex; align-items:center; gap:3px;">
        <button class="btn-sub" onclick="prev()">â†</button>
        <span id="counter" style="font-weight:bold; font-size:13px; min-width:45px; text-align:center;">- / -</span>
        <button class="btn-sub" onclick="next()">â†’</button>
      </div>
      <button id="lockBtn" class="btn-lock" onclick="toggleLock()">ğŸ”“ OFF</button>
    </div>

    <div class="area-box" style="border-left: 5px solid #007bff;">
      <b id="venueName" style="font-size:15px;">-</b>
      <div id="subVenueArea">
        <span class="label-sm">âš ï¸ ãƒ›ãƒ¼ãƒ«ã‚’é¸æŠ:</span>
        <select id="subVenueSelect"></select>
      </div>
      <button class="btn-undo" onclick="undo()">â†© Undo</button>
      <div style="font-size: 11px; clear:both; padding-top:5px;">
        <a id="externalLink" href="#" target="_blank" style="color:#4db8ff; text-decoration:none;">ğŸ”— ã‚µã‚¤ãƒˆã‚’åˆ¥çª“ã§é–‹ã</a>
      </div>
    </div>

    <iframe id="siteFrame" src=""></iframe>

    <div class="area-box editor-grid">
      <div class="full">
        <span class="label-sm">ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ä»˜</span>
        <button onclick="clearFields()" style="float:right; font-size:10px; padding:2px 6px; background:#555; color:#ccc;">Ã— ã‚¯ãƒªã‚¢</button>
        <div style="display:flex; gap:5px;">
          <select id="startDate"></select>
          <select id="endDate"><option value="">ã€œ çµ‚äº†æ—¥</option></select>
        </div>
      </div>
      
      <div class="full">
         <span class="label-sm">é–‹æ¼”æ™‚é–“ / æ‰€è¦æ™‚é–“ (è‡ªå‹•è¨ˆç®—)</span>
         <div style="display:flex; gap:5px;">
            <select id="startTime" onchange="calcEndTime()" style="width:60%;">
              <option value="">-</option>
              <script>for(let h=9; h<=24; h++) for(let m of ['00','15','30','45']) document.write(`<option value="${h}:${m}">${h}:${m}</option>`);</script>
            </select>
            <select id="duration" onchange="calcEndTime()" style="width:40%;">
              <option value="90">1.5h</option>
              <option value="120">2.0h</option>
              <option value="150" selected>2.5h</option>
              <option value="180">3.0h</option>
              <option value="210">3.5h</option>
              <option value="240">4.0h</option>
              <option value="270">4.5h</option>
            </select>
         </div>
      </div>

      <div class="full">
        <span class="label-sm">çµ‚æ¼” (ç¢ºå®š)</span>
        <input type="text" id="endTime" list="endTimeOpts" placeholder="19:00">
        <datalist id="endTimeOpts">
          <script>for(let h=10; h<=23; h++) for(let m of ['00','15','30','45']) document.write(`<option value="${h}:${m}">`);</script>
        </datalist>
      </div>

      <div class="full">
        <span class="label-sm">ä¾¡æ ¼ / è©³ç´°(å±¥æ­´ã‚ã‚Š)</span>
        <div style="display:flex; gap:5px; margin-bottom:5px;">
           <input type="text" id="price" list="priceOpts" placeholder="Â¥5000" style="width:40%;">
           <input type="text" id="detail" list="detailList" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå (ä»»æ„)" style="width:60%;">
        </div>
        <datalist id="priceOpts">
          <script>for(let p=4000; p<=15000; p+=500) document.write(`<option value="${p}">`); for(let p=20000; p<=50000; p+=5000) document.write(`<option value="${p}">`);</script>
        </datalist>
        <datalist id="detailList"></datalist>
      </div>

      <div class="full">
        <span class="label-sm">ğŸ“ å‚™è€ƒ (ä»»æ„)</span>
        <input type="text" id="eventNote" placeholder="ä¾‹: æ±ã‚²ãƒ¼ãƒˆæ¨å¥¨ / ã‚°ãƒƒã‚ºåˆ—ã‚ã‚Š">
      </div>

      <div class="full" style="display: flex; gap: 15px; font-size: 12px; align-items:center;">
        <label><input type="checkbox" id="isHot" style="width:auto;"> æ³¨ç›®â—ï¸</label>
        <label><input type="checkbox" id="isPickup" style="width:auto;"> PUæ²è¼‰</label>
      </div>
      <button class="btn-add" onclick="submitData(false)">ç™»éŒ²(é€£ç¶š)</button>
      <button class="btn-next" onclick="submitData(true)">ç™»éŒ²ã—ã¦æ¬¡ã¸</button>
    </div>

    <div class="global-info">
      <span class="global-header" style="font-weight:bold; font-size:12px; color:#ffc107;">âš ï¸ äº¤é€šæƒ…å ± (æœŸé–“ä¸€æ‹¬ä¿å­˜)</span>
      <div style="display:flex; gap:5px; margin-bottom:5px;">
        <select id="trafficStart"></select>
        <select id="trafficEnd"><option value="">ã€œ çµ‚äº†æ—¥</option></select>
      </div>
      <textarea id="highwayInfo" rows="3" placeholder="ã€é«˜é€Ÿã€‘(è¤‡æ•°è¡ŒOK)&#10;ãƒ»æ¹¾å²¸ç·š è¥¿è¡Œã äº‹æ•…&#10;ãƒ»C1 å·¥äº‹"></textarea>
      <textarea id="etcInfo" rows="2" placeholder="ã€ETCãƒ»å·¥äº‹ã€‘(è¤‡æ•°è¡ŒOK)&#10;ãƒ»ã€‡ã€‡å…¥å£ é–‰é–" style="margin-top:4px;"></textarea>
      
      <div class="link-btn-group" style="margin-top:5px;">
        <a href="https://www.jartic.or.jp/" target="_blank" class="link-btn">JARTIC</a>
        <a href="https://www.shutoko.co.jp/traffic/regulation/schedule/" target="_blank" class="link-btn">é¦–éƒ½é«˜å·¥äº‹</a>
      </div>
      <button class="btn-global" onclick="saveGlobal()">äº¤é€šæƒ…å ±ã‚’ä¿å­˜</button>
    </div>

    <div id="historyBox" class="history">å±¥æ­´èª­ã¿è¾¼ã¿ä¸­...</div>

    <script>
      var venues = <?!= JSON.stringify(venues) ?>;
      var currentIndex = 0;
      var isLocked = false;

      window.onload = function() {
         try {
           google.script.run.withSuccessHandler(function(list) {
              if(!list) return;
              var dl = document.getElementById('detailList');
              if(!dl) return;
              list.forEach(function(item) {
                 var opt = document.createElement('option');
                 opt.value = item;
                 dl.appendChild(opt);
              });
           }).getRecentDetails();
         } catch(e) { console.log(e); }
      };

      function refreshIframe() {
        document.getElementById('siteFrame').src = venues[currentIndex].url;
      }
      function refreshDateLists() {
        var baseDateVal = document.getElementById('baseDate').value;
        if(!baseDateVal) return;
        var baseDate = new Date(baseDateVal);
        var goalDate = new Date(baseDate); goalDate.setDate(baseDate.getDate() + 6);
        var weeks = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
        document.getElementById('goalDisplay').innerText = "ğŸ¯ ä»Šé€±ã®ç›®å®‰: " + (goalDate.getMonth()+1) + "/" + goalDate.getDate() + "(" + weeks[goalDate.getDay()] + ") ã¾ã§";
        function populate(id, withEmpty) {
          var sel = document.getElementById(id);
          sel.innerHTML = withEmpty ? '<option value="">ã€œ çµ‚äº†æ—¥</option>' : '<option value="">é–‹å§‹æ—¥</option>';
          for(var i=0; i<14; i++) {
            var targetDate = new Date(baseDate);
            targetDate.setDate(baseDate.getDate() + i);
            var dateStr = (targetDate.getMonth()+1) + "/" + targetDate.getDate() + "(" + weeks[targetDate.getDay()] + ")";
            var opt = document.createElement('option'); opt.value = dateStr; opt.innerText = dateStr;
            sel.appendChild(opt);
          }
        }
        populate('startDate', false); populate('endDate', true);
        populate('trafficStart', false); populate('trafficEnd', true);
      }
      
      function calcEndTime() { 
        var start = document.getElementById('startTime').value; 
        if (!start) return; 
        var durationMin = parseInt(document.getElementById('duration').value); 
        var parts = start.split(':'); 
        
        var startH = parseInt(parts[0]);
        var startM = parseInt(parts[1]);
        
        var totalMin = (startH * 60) + startM + durationMin;
        var h = Math.floor(totalMin / 60); 
        var m = totalMin % 60;
        
        var displayH = h;
        document.getElementById('endTime').value = (displayH < 10 ? '0' : '') + displayH + ":" + (m < 10 ? '0' : '') + m; 
      }

      function submitData(goNext) {
        var payload = {
          venue: venues[currentIndex].name,
          subVenue: document.getElementById('subVenueSelect').value,
          startDate: document.getElementById('startDate').value,
          endDate: document.getElementById('endDate').value,
          price: document.getElementById('price').value,
          endTime: document.getElementById('endTime').value,
          detail: document.getElementById('detail').value,
          isHot: document.getElementById('isHot').checked,
          isPickup: document.getElementById('isPickup').checked,
          note: document.getElementById('eventNote').value 
        };
        
        // â–¼â–¼â–¼ ä¿®æ­£: å¿…é ˆãƒã‚§ãƒƒã‚¯ã‹ã‚‰detailã‚’å‰Šé™¤ â–¼â–¼â–¼
        if(!payload.startDate || !payload.endTime) { 
            alert("å¿…é ˆé …ç›®(æ—¥ä»˜ãƒ»æ™‚é–“)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); 
            return; 
        }
        
        google.script.run.withSuccessHandler(function(result) {
          if (result === "DUPLICATE") {
            alert("âš ï¸ ã™ã§ã«åŒã˜æ—¥æ™‚ãƒ»ä¼šå ´ã§ç™»éŒ²æ¸ˆã¿ã§ã™ï¼\né‡è¤‡ç™»éŒ²ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚");
          } else {
            if (goNext) { 
              next(); 
            } else {
              var el = document.getElementById('startDate');
              el.classList.add('flash'); setTimeout(function(){ el.classList.remove('flash'); }, 800);
              updateViewHistory(); 
            }
          }
        }).registerEvent(payload);
      }
      
      function updateView() {
        var v = venues[currentIndex];
        document.getElementById('venueName').innerText = v.name;
        document.getElementById('siteFrame').src = v.url;
        document.getElementById('externalLink').href = v.url;
        document.getElementById('counter').innerText = (currentIndex + 1) + " / " + venues.length;
        var subArea = document.getElementById('subVenueArea');
        var subSel = document.getElementById('subVenueSelect');
        subSel.innerHTML = "";
        if (v.halls && v.halls.length > 0) {
          subArea.style.display = "block";
          v.halls.forEach(function(h) { var opt = document.createElement('option'); opt.value = h.trim(); opt.innerText = h.trim(); subSel.appendChild(opt); });
        } else { subArea.style.display = "none"; }
        
        document.getElementById('startDate').value = "";
        document.getElementById('endDate').value = "";
        document.getElementById('endTime').value = "";
        document.getElementById('startTime').value = "";
        document.getElementById('detail').value = "";
        document.getElementById('price').value = "";
        document.getElementById('isHot').checked = false;
        document.getElementById('isPickup').checked = false;
        document.getElementById('eventNote').value = "";
        
        updateViewHistory();
      }
      
      function saveGlobal() {
        var payload = { 
            startDate: document.getElementById('trafficStart').value, 
            endDate: document.getElementById('trafficEnd').value, 
            highway: document.getElementById('highwayInfo').value, 
            etc: document.getElementById('etcInfo').value 
        };
        if(!payload.startDate) { alert("æœŸé–“(é–‹å§‹æ—¥)ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
        google.script.run.withSuccessHandler(function(msg){ alert(msg); }).saveGlobalInfo(payload);
      }
      
      function updateViewHistory() { google.script.run.withSuccessHandler(function(history) { document.getElementById('historyBox').innerHTML = "<b>ä¼šå ´ã®æœ€æ–°å±¥æ­´:</b><br>" + (history.join('<br>') || "ãªã—"); }).getExistingEvents(venues[currentIndex].name); }
      
      function undo() { 
        google.script.run.withSuccessHandler(function(msg){ 
           updateViewHistory(); 
        }).undoLastAction(); 
      }
      
      function next() { if (currentIndex < venues.length - 1) { currentIndex++; updateView(); } }
      function prev() { if (currentIndex > 0) { currentIndex--; updateView(); } }
      function toggleLock() { isLocked = !isLocked; var btn = document.getElementById('lockBtn'); btn.innerText = isLocked ? "ğŸ”’ ON" : "ğŸ”“ OFF"; btn.classList.toggle('locked', isLocked); google.script.run.setSheetLock(isLocked); }
      
      function clearFields() { 
          document.getElementById('startDate').value = ""; 
          document.getElementById('endDate').value = ""; 
          document.getElementById('endTime').value = ""; 
          document.getElementById('detail').value = ""; 
          document.getElementById('price').value = ""; 
          document.getElementById('eventNote').value = "";
      }
      refreshDateLists(); updateView();
    </script>
  </body>
</html>